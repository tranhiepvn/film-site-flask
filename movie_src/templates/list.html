{% extends "layout.html" %}

{#
  Template chung để hiển thị danh sách truyện theo nhiều tiêu chí:
  - Theo thể loại, tác giả, hoặc loại truyện (ngắn/dài).
  - Kết quả tìm kiếm cũng có thể sử dụng template này trong tương lai.
  Biến ``stories`` là danh sách các đối tượng Story cần hiển thị.
  Biến ``pagination`` (nếu có) là đối tượng Flask-SQLAlchemy Pagination để tạo
  liên kết chuyển trang. Biến ``title`` là tiêu đề hiển thị trên trang.
#}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="section listing">
  <h2>{{ title }}</h2>
  {% if stories %}
    <ul class="story-list">
      {% for story in stories %}
        <li>
          <h3><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></h3>
          <p class="meta">
            {# Tác giả #}
            {% if story.author %}
              Tác giả: <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
            {% else %}
              Tác giả: Ẩn danh
            {% endif %}
            |
            Ngày: {{ story.created_at.strftime('%d/%m/%Y') }}
            |
            Loại: <a href="{{ url_for('type_view', story_type=story.story_type) }}">
              {{ 'Phim Ngắn' if story.story_type == 'short' else 'Phim Dài' }}
            </a>
          </p>
          {% if story.categories %}
          <p class="meta">
            Thể loại:
            {% for cat in story.categories %}
              <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          <p class="meta">
            {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
            Đánh giá:
            <span class="rating">
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
              {% endfor %}
              {% if story.rating_count > 0 %} ({{ '%.1f'|format(avg) }}){% else %} (chưa có){% endif %}
            </span>
          </p>
          {# trạng thái hoàn thành/chưa hoàn thành #}
          {% set total_parts = story.parts|length %}
          {% if story.is_completed %}
            <p class="status-message completed-status">
              Phim đã hoàn thành (<em class="completed">{{ total_parts }} phần</em>)
            </p>
          {% else %}
            <p class="status-message updating-status">
              Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần {{ total_parts }}</em>)
            </p>
          {% endif %}
          {# Trích đoạn: cắt ở 200 ký tự và không cắt giữa từ #}
          {% set first_part = story.parts|first %}
          {% if first_part %}
            {% set snippet = first_part.content[:200] %}
            {% if first_part.content|length > 200 %}
              {% set snippet = snippet.rsplit(' ', 1)[0] %}
            {% endif %}
            <p class="snippet">{{ snippet.replace('\n', ' ') }}{% if first_part.content|length > 200 %}...{% endif %}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    {% if pagination %}
      <div class="pagination">
        {% if first_url %}
          <a href="{{ first_url }}">&laquo;&laquo; Trang đầu</a>
        {% endif %}
        {% if prev_url %}
          <a href="{{ prev_url }}">&laquo; Trang trước</a>
        {% endif %}
        {% if next_url %}
          <a href="{{ next_url }}">Trang sau &raquo;</a>
        {% endif %}
        {% if last_url %}
          <a href="{{ last_url }}">Trang cuối &raquo;&raquo;</a>
        {% endif %}
      </div>
    {% endif %}
  {% else %}
    <p>Không có phim nào.</p>
  {% endif %}
</div>
{% endblock %}