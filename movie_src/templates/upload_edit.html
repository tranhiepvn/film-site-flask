{% extends "layout.html" %}

{% block title %}Chỉnh sửa phim{% endblock %}

{% block content %}
<h2>Chỉnh sửa phim</h2>
{% if error %}
  <p class="error">{{ error }}</p>
{% endif %}
<h3>Thông tin cơ bản</h3>
<form method="post">
  <input type="hidden" name="existing_story_id" value="{{ story.id }}">
  <div class="form-group">
    <label for="password">Password:</label><br>
    <input type="password" id="password" name="password" required>
  </div>
  <div class="form-group">
    <label for="title">Tên phim:</label><br>
    <input type="text" id="title" name="title" value="{{ story.title }}" required>
  </div>
  <div class="form-group">
    <label for="author">Tác giả:</label><br>
    <input type="text" id="author" name="author" value="{{ story.author }}">
  </div>
  <div class="form-group">
    <label for="story_type">Loại phim:</label><br>
    <select id="story_type" name="story_type" required>
      <option value="short" {% if story.story_type == 'short' %}selected{% endif %}>Phim Ngắn</option>
      <option value="long" {% if story.story_type == 'long' %}selected{% endif %}>Phim Dài</option>
    </select>
  </div>
  <div class="form-group">
    <label>
      <input type="checkbox" id="is_completed" name="is_completed" {% if story.is_completed %}checked{% endif %}>
      Đánh dấu phim đã hoàn thành
    </label>
  </div>
  <div class="form-group">
    <label>Thể loại (có thể chọn nhiều):</label><br>
    {% if categories %}
      {% for cat in categories %}
        <label>
          <input type="checkbox" name="category_ids" value="{{ cat.id }}" {% if cat in story.categories %}checked{% endif %}>
          {{ cat.name }}
        </label><br>
      {% endfor %}
      <a href="{{ url_for('add_category') }}">Thêm thể loại</a>
    {% else %}
      <em>Chưa có thể loại nào.</em> <a href="{{ url_for('add_category') }}">Thêm thể loại</a>
    {% endif %}
  </div>
  <div class="form-group">
    <button type="submit" name="action" value="update_story">Cập nhật phim</button>
  </div>
</form>

<h3>Ẩn/Hiện phim</h3>
<form method="post" onsubmit="return confirm('Bạn có chắc muốn thay đổi trạng thái hiển thị của phim?');">
  <input type="hidden" name="existing_story_id" value="{{ story.id }}">
  <div class="form-group">
    <label for="password_hide">Password:</label><br>
    <input type="password" id="password_hide" name="password" required>
  </div>
  <div class="form-group">
    <button type="submit" name="action" value="toggle_hidden">
      {% if story.is_hidden %}Hiện lại phim{% else %}Ẩn phim{% endif %}
    </button>
  </div>
</form>

<h3>Danh sách phần</h3>
{% if parts %}
  <ol class="chapter-list">
    {% for part in parts %}
      <li style="margin-bottom: 0.5em;">
        <a href="{{ url_for('upload', story_id=story.id, edit_part=part.id) }}">
          <strong>Phần {{ part.part_number }}</strong>
        </a>
        : {{ part.content[:100].replace('\n',' ') }}{% if part.content|length > 100 %}...{% endif %} ({{ part.created_at.strftime('%d/%m/%Y') }})
      </li>
    {% endfor %}
  </ol>
{% else %}
<p>Chưa có phần nào.</p>
{% endif %}

{# Hiển thị form cập nhật nội dung cho chương nếu có edit_part được chọn #}
{% if edit_part %}
  <h3>Cập nhật phần {{ edit_part.part_number }}</h3>
  {% if error_update %}
    <p class="error">{{ error_update }}</p>
  {% endif %}
  <form method="post">
    <input type="hidden" name="existing_story_id" value="{{ story.id }}">
    <input type="hidden" name="part_id" value="{{ edit_part.id }}">
    <div class="form-group">
      <label for="edit_content">Nội dung phần:</label><br>
      <textarea id="edit_content" name="content" rows="30" cols="80" required>{{ edit_part.content }}</textarea>
    </div>
    <div class="form-group">
      <label>Video liên kết (tối đa 9):</label><br>
      <div class="video-grid">
        {% for i in range(9) %}
        <div class="video-item">
          <input type="url" name="video_urls" id="edit_video_{{ i }}" class="video-input" data-preview="edit_preview_{{ i }}" placeholder="URL video Google Drive" value="{{ edit_part.videos[i].url if edit_part.videos|length > i else '' }}">
          <iframe id="edit_preview_{{ i }}" src="{{ drive_embed(edit_part.videos[i].url) if edit_part.videos|length > i else '' }}" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="form-group">
      <label for="password_update">Password:</label><br>
      <input type="password" id="password_update" name="password" required>
    </div>
    <div class="form-group">
      <button type="submit" name="action" value="update_part">Cập nhật phần</button>
    </div>
  </form>
{% endif %}

<h3>Thêm phần mới</h3>
<form method="post">
  <input type="hidden" name="existing_story_id" value="{{ story.id }}">
  <div class="form-group">
    <label for="new_content">Nội dung phần mới:</label><br>
    <textarea id="new_content" name="content" rows="30" cols="80" required></textarea>
  </div>
  <div class="form-group">
    <label>Video liên kết (tối đa 9):</label><br>
    <div class="video-grid">
      {% for i in range(9) %}
      <div class="video-item">
        <input type="url" name="video_urls" id="new_video_{{ i }}" class="video-input" data-preview="new_preview_{{ i }}" placeholder="URL video Google Drive">
        <iframe id="new_preview_{{ i }}" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="form-group">
    <label for="password2">Password:</label><br>
    <input type="password" id="password2" name="password" required>
  </div>
  <div class="form-group">
    <button type="submit" name="action" value="add_part">Thêm phần</button>
  </div>
</form>

<h3>Xoá phần cuối</h3>
<form method="post" onsubmit="return confirm('Bạn có chắc muốn xoá phần cuối không?');">
  <input type="hidden" name="existing_story_id" value="{{ story.id }}">
  <div class="form-group">
    <label for="password3">Password:</label><br>
    <input type="password" id="password3" name="password" required>
  </div>
  <div class="form-group">
    <button type="submit" name="action" value="delete_last">Xoá phần cuối</button>
  </div>
</form>

<h3>Tìm và thay cụm từ</h3>
<form method="post">
  <input type="hidden" name="existing_story_id" value="{{ story.id }}">
  <div class="form-group">
    <label for="search_string">Tìm:</label><br>
    <input type="text" id="search_string" name="search_string" required>
  </div>
  <div class="form-group">
    <label for="replacement_string">Thay bằng:</label><br>
    <input type="text" id="replacement_string" name="replacement_string" required>
  </div>
  <div class="form-group">
    <label for="password_replace">Password:</label><br>
    <input type="password" id="password_replace" name="password" required>
  </div>
  <div class="form-group">
    <button type="submit" name="action" value="replace_text">Thay</button>
  </div>
</form>

<h3>Xoá phim</h3>
<form method="post" onsubmit="return confirm('Bạn có chắc muốn xoá phim này vĩnh viễn không?');">
  <input type="hidden" name="existing_story_id" value="{{ story.id }}">
  <div class="form-group">
    <label for="password_delete">Password:</label><br>
    <input type="password" id="password_delete" name="password" required>
  </div>
  <div class="form-group">
    <button type="submit" name="action" value="delete_story">Xoá phim</button>
  </div>
</form>

<p><a href="{{ url_for('upload') }}">← Quay về danh sách phim / tạo mới</a></p>

{# Script cập nhật xem trước video cho tất cả input có class video-input #}
<script>
function getDrivePreview(url) {
  var match = url.match(/\/file\/d\/([\w-]+)/);
  if (!match) {
    match = url.match(/id=([\w-]+)/);
  }
  if (match) {
    return 'https://drive.google.com/file/d/' + match[1] + '/preview';
  }
  return '';
}
document.addEventListener('DOMContentLoaded', function() {
  var inputs = document.querySelectorAll('.video-input');
  inputs.forEach(function(input) {
    input.addEventListener('input', function() {
      var previewId = input.getAttribute('data-preview');
      var embedUrl = getDrivePreview(input.value);
      var iframe = document.getElementById(previewId);
      if (iframe) {
        iframe.src = embedUrl;
      }
    });
  });
});
</script>

{% endblock %}