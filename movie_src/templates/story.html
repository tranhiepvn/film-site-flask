{% extends "layout.html" %}

{% block title %}{{ story.title }}{% endblock %}

{% block content %}
<article>
  <h2>{{ story.title }}</h2>
  <p class="meta">
    {# Tác giả: nếu có tên tác giả thì liên kết tới trang tác giả #}
    Tác giả:
    {% if story.author %}
      <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
    {% else %}
      Ẩn danh
    {% endif %}
    |
    Ngày: {{ story.created_at.strftime('%d/%m/%Y %H:%M') }}
    |
    Loại:
    <a href="{{ url_for('type_view', story_type=story.story_type) }}">
      {{ 'Phim Ngắn' if story.story_type == 'short' else 'Phim Dài' }}
    </a>
  </p>
  {# Thể loại: hiển thị danh sách các thể loại với liên kết trên dòng riêng #}
  {% if story.categories %}
  <p class="meta">
    Thể loại:
    {% for cat in story.categories %}
      <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
    {% endfor %}
  </p>
  {% endif %}

  {# Hiển thị trạng thái hoàn thành của phim #}
  {% if story.is_completed %}
    <p class="status-message completed-status">
      Phim đã hoàn thành (<em class="completed">{{ total_parts }} phần</em>)
    </p>
  {% else %}
    <p class="status-message updating-status">
      Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần {{ total_parts }}</em>)
    </p>
  {% endif %}

    {# Hiển thị nội dung từng phần của phim. #}
  {% if total_parts > 0 %}
    {% if total_parts > 1 %}
      <div class="part-navigation">
        {% if current_index > 1 %}
          <a href="{{ url_for('story_detail', story_id=story.id, part=current_index - 1) }}">&larr; Phần trước</a>
        {% endif %}
        {% if current_index < total_parts %}
          {# nếu phim đã hoàn thành và đang ở phần cuối thì hiển thị "Phần cuối" thay cho "Phần sau" #}
          {% if story.is_completed and (current_index + 1 == total_parts) %}
            <a href="{{ url_for('story_detail', story_id=story.id, part=current_index + 1) }}">Phần cuối &rarr;</a>
          {% else %}
            <a href="{{ url_for('story_detail', story_id=story.id, part=current_index + 1) }}">Phần sau &rarr;</a>
          {% endif %}
        {% elif story.is_completed %}
          {# nếu đang ở phần cuối của phim hoàn thành, chỉ hiển thị nhãn #}
          <span class="no-link">Phần cuối</span>
        {% endif %}
      </div>
      <div class="part-list">
        <p>Danh sách phần:</p>
        <ul>
          {% for p in parts %}
            <li style="margin-bottom: 0.5em;">
              {% set _first = p.content.split('\n', 1)[0] %}
              {% if p.part_number == current_index %}
                <strong>{{ _first }}</strong>
              {% else %}
                <a href="{{ url_for('story_detail', story_id=story.id, part=p.part_number) }}">{{ _first }}</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    <div class="story-part">
      {# xử lý nội dung chương: dòng đầu tiên là tiêu đề chương, căn giữa và in đậm #}
      {% if current_part %}
        {% set _lines = current_part.content.split('\n', 1) %}
        {% set chapter_title = _lines[0] %}
        {% set chapter_body = _lines[1] if _lines|length > 1 else '' %}
        <p class="chapter-title">{{ chapter_title }}</p>
        {% if chapter_body %}
          <p>{{ chapter_body.replace('\n', '<br>') | safe }}</p>
        {% endif %}
      {% endif %}
    </div>
    {# Hiển thị các video liên kết (nếu có) ngay dưới nội dung chương #}
    {% if current_part and current_part.videos %}
      <div class="video-section">
        {% for vid in current_part.videos %}
          {# Sử dụng hàm drive_embed để chuyển đổi URL thành liên kết xem trước của Google Drive #}
          <iframe src="{{ drive_embed(vid.url) }}" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        {% endfor %}
      </div>
    {% endif %}
    {# hiển thị đánh giá hiện tại và form đánh giá #}
    <div class="rating-section">
      {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
      <p>Đánh giá hiện tại:
        <span class="rating">
          {% for i in range(1, 6) %}
            {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
          {% endfor %}
          {% if story.rating_count > 0 %}
            ({{ '%.1f'|format(avg) }})
          {% else %}
            (chưa có)
          {% endif %}
        </span>
      </p>
      <form method="post" action="{{ url_for('rate_story', story_id=story.id) }}">
        <div class="rating-form">
          {% for i in range(1, 6) %}
            <label><input type="radio" name="rating" value="{{ i }}" required> {{ i }}</label>
          {% endfor %}
          <button type="submit">Đánh giá</button>
        </div>
      </form>
    </div>
    {# lặp lại điều hướng và danh sách phần bên dưới nội dung để tiện cho người xem #}
    {% if total_parts > 1 %}
      <div class="part-navigation">
        {% if current_index > 1 %}
          <a href="{{ url_for('story_detail', story_id=story.id, part=current_index - 1) }}">&larr; Phần trước</a>
        {% endif %}
        {% if current_index < total_parts %}
          {% if story.is_completed and (current_index + 1 == total_parts) %}
            <a href="{{ url_for('story_detail', story_id=story.id, part=current_index + 1) }}">Phần cuối &rarr;</a>
          {% else %}
            <a href="{{ url_for('story_detail', story_id=story.id, part=current_index + 1) }}">Phần sau &rarr;</a>
          {% endif %}
        {% elif story.is_completed %}
          <span class="no-link">Phần cuối</span>
        {% endif %}
      </div>
      <div class="part-list">
        <p>Danh sách phần:</p>
        <ul>
          {% for p in parts %}
            <li style="margin-bottom: 0.5em;">
              {% set _first = p.content.split('\n', 1)[0] %}
              {% if p.part_number == current_index %}
                <strong>{{ _first }}</strong>
              {% else %}
                <a href="{{ url_for('story_detail', story_id=story.id, part=p.part_number) }}">{{ _first }}</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    {# Hiển thị khu vực bình luận sau nội dung chương và danh sách chương #}
    <div class="comments-section">
      <h3>Bình luận</h3>
      <div class="comment-form">
        <form method="post" action="{{ url_for('post_comment', story_id=story.id) }}">
          <input type="hidden" name="url" value="{{ current_url }}">
          <div class="form-group">
            <label for="comment_name">Tên:</label><br>
            <input type="text" id="comment_name" name="name" placeholder="Tên của bạn (tuỳ chọn)">
          </div>
          {# Bỏ trường email; chỉ thu thập tên và nội dung bình luận #}
          <div class="form-group">
            <label for="comment_content">Nội dung bình luận:</label><br>
            <textarea id="comment_content" name="content" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <button type="submit">Đăng bình luận</button>
          </div>
        </form>
      </div>
      <div class="comment-list">
        {% if comments %}
          {% for cm in comments %}
            <div class="comment">
              <p class="comment-meta">
                <strong>{{ cm.name or 'Ẩn danh' }}</strong> – {{ cm.created_at.strftime('%d/%m/%Y %H:%M') }}
              </p>
              <p class="comment-content">{{ cm.content.replace('\n', '<br>') | safe }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p><em>Chưa có nội dung cho phim này.</em></p>
  {% endif %}
  <p><a href="{{ url_for('index') }}">&larr; Quay lại danh sách</a></p>
</article>
{% endblock %}