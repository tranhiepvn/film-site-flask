<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Trang web phim{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Favicon icon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  </head>
  <body class="{{ request.endpoint }}">
    <div class="container">
      <header>
        <h1><a href="{{ url_for('index') }}" class="home-link">Trang web phim</a></h1>
        <nav>
          <a href="{{ url_for('index') }}">Trang chủ</a><span class="separator">|</span>
          <a href="{{ url_for('upload_login') }}">Admin</a>
        </nav>
        <form action="{{ url_for('search') }}" method="get" class="search-form">
          {# Nếu đang ở trang tìm kiếm thì tự động focus vào ô tìm kiếm để người dùng tiếp tục gõ mà không cần click lại #}
          <input type="text" name="q" placeholder="Tìm kiếm..." value="{{ request.args.get('q', '') }}"
            {% if request.endpoint == 'search' %}
              autofocus onfocus="this.select()"
            {% endif %}>
          <button type="submit">Tìm</button>
        </form>
      </header>
      <div class="content-wrapper">
        {% if categories %}
          <aside class="sidebar">
            <h3>Thể loại</h3>
            <ul class="category-list">
              {# Nhóm 1: các thể loại đặc biệt xuất hiện đầu tiên #}
              {% for cat in categories_group1 %}
                <li class="special-cat">
                  <input type="checkbox" id="cat_checkbox_{{ cat.id }}" data-cat-id="{{ cat.id }}" data-cat-name="{{ cat.name }}">
                  <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>
                </li>
              {% endfor %}
              {% if categories_group1 and categories_group2 %}
                <li class="group-separator"></li>
              {% endif %}
              {# Nhóm 2: các thể loại bắt đầu bằng ký tự hoa #}
              {% for cat in categories_group2 %}
                <li class="uppercase-cat">
                  <input type="checkbox" id="cat_checkbox_{{ cat.id }}" data-cat-id="{{ cat.id }}" data-cat-name="{{ cat.name }}">
                  <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>
                </li>
              {% endfor %}
              {% if categories_group2 and categories_group3 %}
                <li class="group-separator"></li>
              {% endif %}
              {# Nhóm 3: các thể loại còn lại #}
              {% for cat in categories_group3 %}
                <li>
                  <input type="checkbox" id="cat_checkbox_{{ cat.id }}" data-cat-id="{{ cat.id }}" data-cat-name="{{ cat.name }}">
                  <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>
                </li>
              {% endfor %}
            </ul>
          </aside>
        {% endif %}
        <main>
          {# Hiển thị các thông báo flash (nếu có) #}
          {% with messages = get_flashed_messages() %}
            {% if messages %}
              <ul class="flash-messages">
                {% for msg in messages %}
                  <li class="flash">{{ msg }}</li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endwith %}
          {% if error %}
            <p class="error">{{ error }}</p>
          {% endif %}
          {# Khu vực hiển thị danh sách phim theo các thể loại được chọn #}
          <div id="selected-categories-container" class="section selected-categories"></div>
          {% block content %}{% endblock %}
        </main>
      </div>
      <footer>
        <p>&copy; {{ datetime.utcnow().year }} Trang web phim. Cảm ơn bạn đã đến đây, chúc bạn xem phim được thoải mái và vui vẻ. Chúc một ngày hạnh phúc nha bạn!</p>
      </footer>
    </div>
{% block scripts %}
    <script>
      // Script để xử lý việc chọn nhiều thể loại trên tất cả các trang
      document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('selected-categories-container');
        // Nếu không có container (nên luôn có do layout đã chèn), không làm gì
        if (!container) return;
        // Hàm hiển thị danh sách phim cho một thể loại với phân trang
        function renderCategorySection(catId, catName, data) {
          let html = '';
          const page = data.page;
          const total = data.total_pages;
          const stories = data.stories;
          html += `<div class="category-section" id="selected-category-${catId}" data-current-page="${page}" data-total-pages="${total}">`;
          html += `<h2>Phim thể loại ${catName}</h2>`;
          if (stories.length > 0) {
            html += '<ul class="story-list">';
            stories.forEach(function(story) {
              let stars = '';
              const avg = story.rating || 0;
              for (let i = 1; i <= 5; i++) {
                stars += i <= Math.floor(avg) ? '★' : '☆';
              }
              const ratingText = story.rating_count > 0 ? ` (${avg.toFixed(1)})` : ' (chưa có)';
              const authorHtml = story.author ? `Tác giả: <a href="/author/${encodeURIComponent(story.author)}">${story.author}</a>` : 'Tác giả: Ẩn danh';
              let categoriesHtml = '';
              if (story.categories && story.categories.length > 0) {
                categoriesHtml = 'Thể loại: ' + story.categories.map(function(n) { return `<span>${n}</span>`; }).join(', ');
              }
              html += '<li>';
              html += `<h3><a href="/story/${story.id}">${story.title}</a></h3>`;
              html += `<p class="meta">${authorHtml}</p>`;
              if (categoriesHtml) {
                html += `<p class="meta">${categoriesHtml}</p>`;
              }
              html += `<p class="meta">Đánh giá: <span class="rating">${stars}${ratingText}</span></p>`;
              if (story.is_completed) {
                html += `<p class="status-message completed-status">Phim đã hoàn thành (<em class="completed">${story.part_count} phần</em>)</p>`;
              } else {
                html += `<p class="status-message updating-status">Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần ${story.part_count}</em>)</p>`;
              }
              if (story.snippet) {
                html += `<p class="snippet">${story.snippet}</p>`;
              }
              html += '</li>';
            });
            html += '</ul>';
          } else {
            html += '<p>Chưa có phim trong thể loại này.</p>';
          }
          // Điều hướng phân trang
          html += '<div class="pagination">';
          if (data.has_prev) {
            html += `<a href="#" data-cat-id="${catId}" data-page="1">&laquo;&laquo; Trang đầu</a>`;
            html += `<a href="#" data-cat-id="${catId}" data-page="${page - 1}">&laquo; Trang trước</a>`;
          }
          if (data.has_next) {
            html += `<a href="#" data-cat-id="${catId}" data-page="${page + 1}">Trang sau &raquo;</a>`;
            html += `<a href="#" data-cat-id="${catId}" data-page="${total}">Trang cuối &raquo;&raquo;</a>`;
          }
          html += '</div>';
          html += '</div>';
          return html;
        }
        // Hàm tải dữ liệu phim của thể loại và cập nhật phần hiển thị
        function loadCategory(catId, catName, page = 1) {
          fetch(`/api/category_stories/${catId}?page=${page}&limit=25`)
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
              // Nếu chưa có section cho catId thì tạo mới, ngược lại cập nhật
              const sectionId = `selected-category-${catId}`;
              let section = document.getElementById(sectionId);
              const html = renderCategorySection(catId, catName, data);
              if (section) {
                section.outerHTML = html;
              } else {
                container.insertAdjacentHTML('beforeend', html);
              }
            });
        }
        // Gắn listener cho các checkbox thể loại
        const checkboxes = document.querySelectorAll('.category-list input[type="checkbox"]');
        checkboxes.forEach(function(cb) {
          cb.addEventListener('change', function() {
            const catId = this.getAttribute('data-cat-id');
            const catName = this.getAttribute('data-cat-name');
            if (this.checked) {
              loadCategory(catId, catName, 1);
            } else {
              // Bỏ chọn thì xoá section tương ứng
              const sec = document.getElementById(`selected-category-${catId}`);
              if (sec) sec.remove();
            }
          });
        });
        // Lắng nghe sự kiện click trên các liên kết phân trang cho danh sách thể loại
        container.addEventListener('click', function(evt) {
          const link = evt.target.closest('a');
          if (link && link.dataset.catId && link.dataset.page) {
            evt.preventDefault();
            const catId = link.dataset.catId;
            const page = parseInt(link.dataset.page);
            const cb = document.querySelector(`.category-list input[data-cat-id="${catId}"]`);
            if (cb && cb.checked) {
              const catName = cb.getAttribute('data-cat-name');
              loadCategory(catId, catName, page);
            }
          }
        });
      });
    </script>
    {% endblock %}
  </body>
</html>