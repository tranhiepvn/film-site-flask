{% extends "layout.html" %}

{#
  Trang chủ hiển thị ba phần chính:
  1. Truyện nổi bật: tối đa 20 truyện có lượt xem cao nhất. Mỗi mục hiển thị tiêu đề,
     tác giả (có liên kết) và trích đoạn của phần đầu tiên.
  2. Truyện Ngắn: danh sách 10 truyện ngắn mới nhất (truyện_type == 'short') cùng với
     tác giả, thể loại và đoạn trích. Có liên kết tới trang truyện ngắn khi nhấp vào
     tiêu đề phần. Hỗ trợ chuyển trang bằng tham số ``short_page``.
  3. Truyện Dài: danh sách 10 truyện dài mới nhất (story_type == 'long') cùng các
     thông tin tương tự như mục 2. Có chuyển trang bằng tham số ``long_page``.
#}

{% block title %}Xem phim hay{% endblock %}

{% block content %}
  <!-- Vùng hiển thị các phim thuộc các thể loại được chọn -->
  <div id="selected-categories-container" class="section selected-categories"></div>
  {# Mục phim mới cập nhật: hiển thị những phim có phần mới được thêm gần đây nhất #}
  <div class="section recent">
  <h2>Phim mới cập nhật</h2>
  {% if recent_stories %}
    <ul class="story-list">
      {% for story in recent_stories %}
        <li>
          <h3><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></h3>
          <p class="meta">
            {% if story.author %}
              Tác giả: <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
            {% else %}
              Tác giả: Ẩn danh
            {% endif %}
          </p>
          {% if story.categories %}
          <p class="meta">
            Thể loại:
            {% for cat in story.categories %}
              <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          <p class="meta">
            {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
            Đánh giá:
            <span class="rating">
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
              {% endfor %}
              {% if story.rating_count > 0 %} ({{ '%.1f'|format(avg) }}){% else %} (chưa có){% endif %}
            </span>
          </p>
          {# trạng thái hoàn thành/chưa hoàn thành #}
          {% set total_parts = story.parts|length %}
          {% if story.is_completed %}
            <p class="status-message completed-status">
            Phim đã hoàn thành (<em class="completed">{{ total_parts }} phần</em>)
            </p>
          {% else %}
            <p class="status-message updating-status">
            Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần {{ total_parts }}</em>)
            </p>
          {% endif %}
          {% set first_part = story.parts|first %}
          {% if first_part %}
            {# Trích đoạn: cắt ở 200 ký tự và không cắt giữa từ #}
            {% set snippet = first_part.content[:200] %}
            {% if first_part.content|length > 200 %}
              {% set snippet = snippet.rsplit(' ', 1)[0] %}
            {% endif %}
            <p class="snippet">{{ snippet.replace('\n', ' ') }}{% if first_part.content|length > 200 %}...{% endif %}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Chưa có phim mới cập nhật.</p>
  {% endif %}
  </div>

  <div class="section best">
  <h2>Phim hay nhất</h2>
  {% if best %}
    <ul class="story-list">
      {% for story in best %}
        <li>
          <h3><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></h3>
          <p class="meta">
            {% if story.author %}
              Tác giả: <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
            {% else %}
              Tác giả: Ẩn danh
            {% endif %}
          </p>
          {% if story.categories %}
          <p class="meta">
            Thể loại:
            {% for cat in story.categories %}
              <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          <p class="meta">
            {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
            Đánh giá:
            <span class="rating">
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
              {% endfor %}
              {% if story.rating_count > 0 %} ({{ '%.1f'|format(avg) }}){% else %} (chưa có){% endif %}
            </span>
          </p>
          {# trạng thái hoàn thành/chưa hoàn thành #}
          {% set total_parts = story.parts|length %}
          {% if story.is_completed %}
            <p class="status-message completed-status">
              Phim đã hoàn thành (<em class="completed">{{ total_parts }} phần</em>)
            </p>
          {% else %}
            <p class="status-message updating-status">
              Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần {{ total_parts }}</em>)
            </p>
          {% endif %}
          {% set first_part = story.parts|first %}
          {% if first_part %}
            {# Trích đoạn: cắt ở 200 ký tự và không cắt giữa từ #}
            {% set snippet = first_part.content[:200] %}
            {% if first_part.content|length > 200 %}
              {% set snippet = snippet.rsplit(' ', 1)[0] %}
            {% endif %}
            <p class="snippet">{{ snippet.replace('\n', ' ') }}{% if first_part.content|length > 200 %}...{% endif %}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Chưa có phim được đánh giá.</p>
  {% endif %}
  </div>

  <div class="section trending">
  <h2>Phim nhiều người xem nhất</h2>
  {% if trending %}
    <ul class="story-list">
      {% for story in trending %}
        <li>
          <h3><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></h3>
          <p class="meta">
            Lượt xem: {{ story.views }}
            {% if story.author %}
              | Tác giả: <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
            {% else %}
              | Tác giả: Ẩn danh
            {% endif %}
          </p>
          {% if story.categories %}
          <p class="meta">
            Thể loại:
            {% for cat in story.categories %}
              <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          <p class="meta">
            {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
            Đánh giá:
            <span class="rating">
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
              {% endfor %}
              {% if story.rating_count > 0 %}
                ({{ '%.1f'|format(avg) }})
              {% else %}
                (chưa có)
              {% endif %}
            </span>
          </p>
          {# trạng thái hoàn thành/chưa hoàn thành #}
          {% set total_parts = story.parts|length %}
          {% if story.is_completed %}
            <p class="status-message completed-status">
              Phim đã hoàn thành (<em class="completed">{{ total_parts }} phần</em>)
            </p>
          {% else %}
            <p class="status-message updating-status">
              Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần {{ total_parts }}</em>)
            </p>
          {% endif %}
          {% set first_part = story.parts|first %}
          {% if first_part %}
            {# Trích đoạn: cắt ở 200 ký tự và không cắt giữa từ #}
            {% set snippet = first_part.content[:200] %}
            {% if first_part.content|length > 200 %}
              {% set snippet = snippet.rsplit(' ', 1)[0] %}
            {% endif %}
            <p class="snippet">{{ snippet.replace('\n', ' ') }}{% if first_part.content|length > 200 %}...{% endif %}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Chưa có phim nhiều người xem nhất.</p>
  {% endif %}
  </div>

  <div class="section short">
  <h2><a href="{{ url_for('type_view', story_type='short') }}">Phim Ngắn</a></h2>
  {% if short_stories %}
    <ul class="story-list">
      {% for story in short_stories %}
        <li>
          <h3><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></h3>
          <p class="meta">
            {% if story.author %}
              Tác giả: <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
            {% else %}
              Tác giả: Ẩn danh
            {% endif %}
          </p>
          {% if story.categories %}
          <p class="meta">
            Thể loại:
            {% for cat in story.categories %}
              <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          <p class="meta">
            {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
            Đánh giá:
            <span class="rating">
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
              {% endfor %}
              {% if story.rating_count > 0 %} ({{ '%.1f'|format(avg) }}){% else %} (chưa có){% endif %}
            </span>
          </p>
          {# trạng thái hoàn thành/chưa hoàn thành #}
          {% set total_parts = story.parts|length %}
          {% if story.is_completed %}
            <p class="status-message completed-status">
              Phim đã hoàn thành (<em class="completed">{{ total_parts }} phần</em>)
            </p>
          {% else %}
            <p class="status-message updating-status">
              Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần {{ total_parts }}</em>)
            </p>
          {% endif %}
          {% set first_part = story.parts|first %}
          {% if first_part %}
            {# Trích đoạn: cắt ở 200 ký tự và không cắt giữa từ #}
            {% set snippet = first_part.content[:200] %}
            {% if first_part.content|length > 200 %}
              {% set snippet = snippet.rsplit(' ', 1)[0] %}
            {% endif %}
            <p class="snippet">{{ snippet.replace('\n',' ') }}{% if first_part.content|length > 200 %}...{% endif %}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    <div class="pagination">
      {% if short_pagination.has_prev %}
        <a href="{{ url_for('index', short_page=short_pagination.prev_num, long_page=long_pagination.page) }}">&laquo; Trang trước</a>
      {% endif %}
      {% if short_pagination.has_next %}
        <a href="{{ url_for('index', short_page=short_pagination.next_num, long_page=long_pagination.page) }}">Trang tiếp theo &raquo;</a>
      {% endif %}
    </div>
  {% else %}
    <p>Chưa có phim ngắn.</p>
  {% endif %}
  </div>

  <div class="section long">
  <h2><a href="{{ url_for('type_view', story_type='long') }}">Phim Dài</a></h2>
  {% if long_stories %}
    <ul class="story-list">
      {% for story in long_stories %}
        <li>
          <h3><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></h3>
          <p class="meta">
            {% if story.author %}
              Tác giả: <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
            {% else %}
              Tác giả: Ẩn danh
            {% endif %}
          </p>
          {% if story.categories %}
          <p class="meta">
            Thể loại:
            {% for cat in story.categories %}
              <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          <p class="meta">
            {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
            Đánh giá:
            <span class="rating">
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
              {% endfor %}
              {% if story.rating_count > 0 %} ({{ '%.1f'|format(avg) }}){% else %} (chưa có){% endif %}
            </span>
          </p>
          {# trạng thái hoàn thành/chưa hoàn thành #}
          {% set total_parts = story.parts|length %}
          {% if story.is_completed %}
            <p class="status-message completed-status">
              Phim đã hoàn thành (<em class="completed">{{ total_parts }} phần</em>)
            </p>
          {% else %}
            <p class="status-message updating-status">
              Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần {{ total_parts }}</em>)
            </p>
          {% endif %}
          {% set first_part = story.parts|first %}
          {% if first_part %}
            {# Trích đoạn: cắt ở 200 ký tự và không cắt giữa từ #}
            {% set snippet = first_part.content[:200] %}
            {% if first_part.content|length > 200 %}
              {% set snippet = snippet.rsplit(' ', 1)[0] %}
            {% endif %}
            <p class="snippet">{{ snippet.replace('\n',' ') }}{% if first_part.content|length > 200 %}...{% endif %}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    <div class="pagination">
      {% if long_pagination.has_prev %}
        <a href="{{ url_for('index', short_page=short_pagination.page, long_page=long_pagination.prev_num) }}">&laquo; Trang trước</a>
      {% endif %}
      {% if long_pagination.has_next %}
        <a href="{{ url_for('index', short_page=short_pagination.page, long_page=long_pagination.next_num) }}">Trang tiếp theo &raquo;</a>
      {% endif %}
    </div>
  {% else %}
    <p>Chưa có phim dài.</p>
  {% endif %}
  </div>
{% endblock %}

{# Khối scripts dành riêng cho trang phim để xử lý chọn nhiều thể loại #}
{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('selected-categories-container');

      /**
       * Tạo HTML cho danh sách phim của một thể loại với phân trang.
       * @param {string} catId ID của thể loại
       * @param {string} catName Tên thể loại
       * @param {Object} data Đối tượng trả về từ API gồm stories, page, total_pages, has_prev, has_next
       */
      function renderCategorySection(catId, catName, data) {
        let html = '';
        const page = data.page;
        const total = data.total_pages;
        const stories = data.stories;
        html += `<div class="category-section" id="selected-category-${catId}" data-current-page="${page}" data-total-pages="${total}">`;
        html += `<h2>Phim thể loại ${catName}</h2>`;
        if (stories.length > 0) {
          html += '<ul class="story-list">';
          stories.forEach(function(story) {
            let stars = '';
            const avg = story.rating || 0;
            for (let i = 1; i <= 5; i++) {
              stars += i <= Math.floor(avg) ? '★' : '☆';
            }
            const ratingText = story.rating_count > 0 ? ` (${avg.toFixed(1)})` : ' (chưa có)';
            const authorHtml = story.author ? `Tác giả: <a href="/author/${encodeURIComponent(story.author)}">${story.author}</a>` : 'Tác giả: Ẩn danh';
            let categoriesHtml = '';
            if (story.categories && story.categories.length > 0) {
              categoriesHtml = 'Thể loại: ' + story.categories.map(function(n) { return `<span>${n}</span>`; }).join(', ');
            }
            html += '<li>';
            html += `<h3><a href="/story/${story.id}">${story.title}</a></h3>`;
            html += `<p class="meta">${authorHtml}</p>`;
            if (categoriesHtml) {
              html += `<p class="meta">${categoriesHtml}</p>`;
            }
            html += `<p class="meta">Đánh giá: <span class="rating">${stars}${ratingText}</span></p>`;
            if (story.is_completed) {
              html += `<p class="status-message completed-status">Phim đã hoàn thành (<em class="completed">${story.part_count} phần</em>)</p>`;
            } else {
              html += `<p class="status-message updating-status">Phim chưa hoàn thành (<em class="updating">Cập nhật đến phần ${story.part_count}</em>)</p>`;
            }
            if (story.snippet) {
              html += `<p class="snippet">${story.snippet}</p>`;
            }
            html += '</li>';
          });
          html += '</ul>';
        } else {
          html += '<p>Chưa có phim trong thể loại này.</p>';
        }
        // Tạo thanh điều hướng phân trang
        html += '<div class="pagination">';
        if (data.has_prev) {
          html += `<a href="#" data-cat-id="${catId}" data-page="1">&laquo;&laquo; Trang đầu</a>`;
          html += `<a href="#" data-cat-id="${catId}" data-page="${page - 1}">&laquo; Trang trước</a>`;
        }
        if (data.has_next) {
          html += `<a href="#" data-cat-id="${catId}" data-page="${page + 1}">Trang sau &raquo;</a>`;
          html += `<a href="#" data-cat-id="${catId}" data-page="${total}">Trang cuối &raquo;&raquo;</a>`;
        }
        html += '</div>';
        html += '</div>';
        return html;
      }

      /**
       * Tải dữ liệu trang cho thể loại
       * @param {string} catId ID thể loại
       * @param {string} catName Tên thể loại
       * @param {number} page Số trang cần tải
       */
      function loadCategoryPage(catId, catName, page) {
        fetch(`/api/category_stories/${catId}?page=${page}&limit=25`)
          .then(function(resp) { return resp.json(); })
          .then(function(data) {
            const sectionHtml = renderCategorySection(catId, catName, data);
            const existing = document.getElementById('selected-category-' + catId);
            if (existing) {
              existing.outerHTML = sectionHtml;
            } else {
              container.insertAdjacentHTML('beforeend', sectionHtml);
            }
          });
      }

      // Xử lý click trên các nút phân trang trong các khu vực thể loại
      container.addEventListener('click', function(event) {
        const target = event.target;
        if (target.tagName === 'A' && target.hasAttribute('data-cat-id') && target.hasAttribute('data-page')) {
          event.preventDefault();
          const catId = target.getAttribute('data-cat-id');
          const page = parseInt(target.getAttribute('data-page'), 10);
          const checkbox = document.querySelector(`.category-list input[data-cat-id="${catId}"]`);
          const catName = checkbox ? checkbox.getAttribute('data-cat-name') : '';
          loadCategoryPage(catId, catName, page);
        }
      });

      // Lắng nghe thay đổi checkbox để nạp dữ liệu hoặc xoá mục
      document.querySelectorAll('.category-list input[type="checkbox"]').forEach(function(cb) {
        cb.addEventListener('change', function() {
          const catId = cb.getAttribute('data-cat-id');
          const catName = cb.getAttribute('data-cat-name');
          if (cb.checked) {
            loadCategoryPage(catId, catName, 1);
          } else {
            const existing = document.getElementById('selected-category-' + catId);
            if (existing) {
              existing.parentNode.removeChild(existing);
            }
          }
        });
      });
    });
  </script>
{% endblock %}