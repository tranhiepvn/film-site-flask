{% extends "layout.html" %}

{% block title %}{{ category.name }}{% endblock %}

{% block content %}
<div class="section listing">
  <h2>Thể loại: {{ category.name }}</h2>
  {% if stories %}
    <ul class="story-list">
      {% for story in stories %}
        <li>
          <h3><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></h3>
          <p class="meta">
            {% if story.author %}
              Tác giả: <a href="{{ url_for('author_view', author=story.author) }}">{{ story.author }}</a>
            {% else %}
              Tác giả: Ẩn danh
            {% endif %}
            | Ngày: {{ story.created_at.strftime('%d/%m/%Y') }}
            | Loại: <a href="{{ url_for('type_view', story_type=story.story_type) }}">{{ 'Truyện Ngắn' if story.story_type == 'short' else 'Truyện Dài' }}</a>
          </p>
          {% if story.categories %}
          <p class="meta">
            Thể loại:
            {% for cat in story.categories %}
              <a href="{{ url_for('category_view', category_id=cat.id) }}">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
          {% endif %}
          <p class="meta">
            {% set avg = (story.rating_sum / story.rating_count) if story.rating_count > 0 else 0 %}
            Đánh giá:
            <span class="rating">
              {% for i in range(1,6) %}
                {% if i <= avg|round(0, 'floor') %}★{% else %}☆{% endif %}
              {% endfor %}
              {% if story.rating_count > 0 %} ({{ '%.1f'|format(avg) }}){% else %} (chưa có){% endif %}
            </span>
          </p>
          {% set total_parts = story.parts|length %}
          {# Trạng thái hoàn thành hoặc đang cập nhật #}
          {% if story.is_completed %}
            <p class="status-message completed-status">
              Truyện đã hoàn thành (<em class="completed">{{ total_parts }} chương</em>)
            </p>
          {% else %}
            <p class="status-message updating-status">
              Truyện chưa hoàn thành (<em class="updating">Cập nhật đến chương {{ total_parts }}</em>)
            </p>
          {% endif %}
          {# Trích đoạn từ chương đầu tiên, in nghiêng #}
          {% set first_part = story.parts|first %}
          {% if first_part %}
            {% set snippet = first_part.content[:200] %}
            {% if first_part.content|length > 200 %}
              {% set snippet = snippet.rsplit(' ', 1)[0] %}
            {% endif %}
            <p class="snippet">{{ snippet.replace('\n', ' ') }}{% if first_part.content|length > 200 %}...{% endif %}</p>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Chưa có truyện trong thể loại này.</p>
  {% endif %}
</div>
{% endblock %}