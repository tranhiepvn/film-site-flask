{% extends "layout.html" %}

{% block title %}Xác nhận import dữ liệu{% endblock %}

{% block content %}
<h2>Xác nhận import dữ liệu</h2>
<p>Có {{ duplicates|length }} phim trùng tên. Số phim không trùng: {{ success_count }}.</p>
<p>Vui lòng chọn hành động cho từng phim trùng tên: "Overwrite" để xoá phim hiện có và import phim từ file JSON, hoặc "Skip" để bỏ qua và giữ nguyên phim hiện có.</p>
<form method="post" action="{{ url_for('import_confirm') }}">
  <input type="hidden" name="temp_file" value="{{ temp_file }}">
  {% for dup in duplicates %}
  <div class="duplicate-item">
    <p><strong>{{ loop.index }}: {{ dup.title }}</strong></p>
    <p class="snippet-db">{{ dup.db_snippet }}</p>
    <p class="snippet-json">{{ dup.json_snippet }}</p>
    <p class="decision">
      <label><input type="radio" name="decision_{{ dup.json_id }}" value="overwrite" checked> Overwrite</label>
      <label style="margin-left:1em;"><input type="radio" name="decision_{{ dup.json_id }}" value="skip"> Skip</label>
    </p>
  </div>
  {% endfor %}
  <div class="form-group">
    <p>Áp dụng cho tất cả:</p>
    <label><input type="radio" name="apply_all" value="none" checked> None</label>
    <label style="margin-left:1em;"><input type="radio" name="apply_all" value="skip_all"> Skip all</label>
    <label style="margin-left:1em;"><input type="radio" name="apply_all" value="overwrite_all"> Overwrite all</label>
  </div>
  <div class="form-group">
    <label for="import_password">Password:</label><br>
    <input type="password" id="import_password" name="password" required>
  </div>
  <div class="form-group">
    <button type="submit">Thực hiện import</button>
  </div>
</form>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Đặt mặc định cho tất cả phim trùng là Skip
    document.querySelectorAll('.duplicate-item').forEach(function(item) {
      var skipRadio = item.querySelector('input[type="radio"][value="skip"]');
      if (skipRadio) {
        skipRadio.checked = true;
      }
    });
    // Xử lý tuỳ chọn áp dụng chung: skip_all hoặc overwrite_all
    var applyRadios = document.querySelectorAll('input[name="apply_all"]');
    applyRadios.forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (this.value === 'skip_all' || this.value === 'overwrite_all') {
          var desired = this.value === 'skip_all' ? 'skip' : 'overwrite';
          document.querySelectorAll('.duplicate-item').forEach(function(item) {
            var radios = item.querySelectorAll('input[type="radio"]');
            radios.forEach(function(r) {
              if (r.value === desired) {
                r.checked = true;
              }
            });
          });
        }
      });
    });
  });
</script>
{% endblock %}